name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  server:
    name: Server Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./server
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Generate ANTLR parser
        working-directory: ./server
        run: |
          if ! command -v java &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y default-jdk
          fi
          make generate
      
      - name: Check syntax and imports
        working-directory: ./server
        run: |
          python -m py_compile dsl_interpreter.py main.py run_server.py
          python -c "from dsl_interpreter import AlgorithmSessionManager; from main import app; print('✓ All imports OK')"
      
      - name: Test command parsing
        working-directory: ./server
        run: |
          python - << 'EOF'
          from dsl_interpreter import AlgorithmSessionManager
          mgr = AlgorithmSessionManager()
          
          tests = [
              ('menu', 'menu'),
              ('sorting', 'sorting'),
              ('sorting', '1'),
              ('sorting', '5,2,8,1'),
              ('sorting', 'next'),
              ('sorting', 'explain'),
              ('reset', 'reset'),
          ]
          
          for session_id, cmd in tests:
              result = mgr.handle_command(session_id, cmd)
              print(f"✓ '{cmd}' -> {result['type']}")
          
          print("\n✅ All server commands working!")
          EOF

  client:
    name: Client Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: algorithms-visualizer-client/package-lock.json
      
      - name: Install dependencies
        working-directory: ./algorithms-visualizer-client
        run: npm ci
      
      - name: Run ESLint
        working-directory: ./algorithms-visualizer-client
        run: npm run lint
      
      - name: Type check with TypeScript
        working-directory: ./algorithms-visualizer-client
        run: npx tsc --noEmit
