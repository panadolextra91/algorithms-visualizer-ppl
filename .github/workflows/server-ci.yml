name: Server CI

on:
  push:
    paths:
      - 'server/**'
      - '.github/workflows/server-ci.yml'
  pull_request:
    paths:
      - 'server/**'
      - '.github/workflows/server-ci.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./server
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Generate ANTLR parser
        working-directory: ./server
        run: |
          # Check if Java is available (required for ANTLR)
          if ! command -v java &> /dev/null; then
            echo "Java not found, installing..."
            sudo apt-get update
            sudo apt-get install -y default-jdk
          fi
          make generate
      
      - name: Check syntax
        working-directory: ./server
        run: |
          python -m py_compile dsl_interpreter.py main.py run_server.py
      
      - name: Test imports
        working-directory: ./server
        run: |
          python -c "from dsl_interpreter import AlgorithmSessionManager; print('✓ Imports OK')"
          python -c "from main import app; print('✓ FastAPI app OK')"
      
      - name: Test command parsing
        working-directory: ./server
        run: |
          python - << 'EOF'
          from dsl_interpreter import AlgorithmSessionManager
          mgr = AlgorithmSessionManager()
          
          # Test all commands
          tests = [
              ('menu', 'menu'),
              ('sorting', 'sorting'),
              ('sorting', '1'),
              ('sorting', '5,2,8,1'),
              ('sorting', 'next'),
              ('sorting', 'explain'),
              ('reset', 'reset'),
          ]
          
          for session_id, cmd in tests:
              try:
                  result = mgr.handle_command(session_id, cmd)
                  print(f"✓ '{cmd}' -> {result['type']}")
              except Exception as e:
                  print(f"✗ '{cmd}' -> Error: {e}")
                  raise
          
          print("\n✅ All commands working!")
          EOF
